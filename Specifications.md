# SwiftViewer 仕様一覧

## 1. アプリケーション概要
**SwiftViewer** は、macOS向けの高速な画像・動画ビューアおよび管理アプリケーションです。Adobe Lightroom ClassicやBridgeにインスパイアされた3ペイン構成のUIを持ち、大量のメディアファイルを効率的に閲覧、整理、管理することができます。

## 2. ユーザーインターフェース (UI)
### 2.1 レイアウト
- **3ペイン構成**:
    - **左ペイン (サイドバー)**: フォルダツリー、カタログ（コレクション）
    - **中央ペイン (グリッド/プレビュー)**: サムネイル一覧、または単一ファイルの拡大表示
    - **右ペイン (インスペクタ)**: メタデータ表示、レーティング・ラベル操作、マップ
- **リサイズ**: 各ペインの幅はドラッグで調整可能。サムネイルペインの幅はアプリ終了後も保持される（`@AppStorage`）。
- **ダークモード対応**: macOSのシステム設定に従う。

### 2.2 サイドバー
- **Locations (ファイルシステム)**:
    - マウントされたボリュームとホームディレクトリ配下のフォルダを階層表示。
    - システムアイコン（フォルダ、ディスク等）の使用。
    - **ドラッグ＆ドロップ**: フォルダへのファイル移動・コピーに対応。
    - **選択**: アイコンまたはフォルダ名をクリックして選択（青背景・白文字のハイライト）。
- **Catalog (仮想コレクション)**:
    - ユーザーが作成した任意のコレクション（アルバム）。
    - **機能**:
        - 新規作成、名前変更、削除。
        - ファイルのドラッグ＆ドロップによる追加（実体は移動せず参照のみ）。
        - 階層構造のサポート（フォルダの中にフォルダ）。
        - ドラッグによる並び替え。
    - **永続化**: Core Dataを使用して保存。

### 2.3 グリッドビュー (サムネイル一覧)
- **表示**:
    - `LazyVGrid` を使用した高速なスクロール。
    - **サムネイルサイズ変更**: ツールバーのスライダーで50px〜300pxの範囲で調整可能。
    - **情報表示**: ファイル名、レーティング（星）、カラーラベル（枠線または背景）。
- **操作**:
    - **選択**: クリックで単一選択、Cmd+クリックで複数選択、Shift+クリックで範囲選択。
    - **キーボード操作**: 矢印キーでの移動、Shift+矢印での範囲選択。
    - **ダブルクリック**: プレビューモード（拡大表示）への切り替え。
    - **コンテキストメニュー**:
        - Finderで表示
        - ゴミ箱に入れる
        - カタログに追加
        - レーティング・カラーラベル設定
- **並び替え**:
    - 日付（作成日/撮影日）、ファイル名、ファイルサイズでの昇順・降順ソート。
- **フィルタリング**:
    - レーティング（★1以上など）
    - カラーラベル（指定した色のみ表示）

### 2.4 プレビュービュー (詳細表示)
- **画像表示**:
    - 高解像度画像の表示。
    - **ズーム**: ピンチジェスチャまたはダブルクリックで拡大/縮小。
    - **パン**: 拡大時のドラッグ移動。
- **動画再生**:
    - `AVPlayer` を使用した動画再生。
    - 再生/一時停止、シークバー。
- **ナビゲーション**:
    - 左右キーまたはボタンで前後のファイルへ移動。
    - スペースキーでQuick Look（macOS標準）の呼び出し。

### 2.5 インスペクタ (右ペイン)
- **情報表示**:
    - ファイル名、解像度、ファイルサイズ、作成日。
    - **EXIF情報**: カメラモデル、F値、シャッタースピード、ISO感度、焦点距離など。
    - **ヒストグラム**: RGBヒストグラムの表示（実装済みだが簡易的な場合あり）。
- **編集・管理**:
    - **レーティング**: 0〜5の星を設定。
    - **カラーラベル**: 7色（なし、赤、オレンジ、黄、緑、青、紫、グレー）を設定。
- **マップ**:
    - GPS情報が含まれる場合、撮影場所を地図（MapKit）上にピン表示。

## 3. 機能・ロジック
### 3.1 ファイル操作
- **コピー・移動**:
    - サイドバーのフォルダへのドラッグ＆ドロップで実行。
    - **同一ボリューム内**: 高速な移動（Move）。
    - **別ボリューム間**: コピー（Copy）後に元ファイルを削除（ユーザー確認あり）。
    - **進捗表示**:
        - 処理中は画面全体をブロックするオーバーレイを表示。
        - 「X個中 Y個目のアイテムをコピー中...」という詳細な進捗メッセージとプログレスバーを表示。
        - UIスレッドをブロックしないよう、バックグラウンド処理とスロットリング（更新頻度調整）を実装。
- **削除**:
    - ゴミ箱への移動（`FileManager.trashItem`）。

### 3.2 サムネイル生成
- **非同期処理**:
    - `Task` と `Actor` を使用した並列生成。
    - メインスレッドをブロックしないスムーズなスクロール。
- **キャッシュ**:
    - **メモリキャッシュ**: `NSCache` を使用し、アプリ起動中の高速表示。
    - **ディスクキャッシュ**: 生成したサムネイルをディスクに保存し、次回起動時の高速化。
    - **管理**: 元ファイルが削除・移動された場合、対応するキャッシュも削除。

### 3.3 データ管理 (Core Data)
- **Catalog**: コレクション構造とファイル参照を保存。
- **Metadata**: レーティングやカラーラベルなどのユーザー付与情報を保存（サイドカーファイルではなくDB管理）。
- **整合性**: ファイル移動・リネーム時にCore Data上のパス情報を自動更新。

### 3.4 パフォーマンス最適化
- **遅延読み込み**: グリッド表示範囲のサムネイルのみ生成・読み込み。
- **バッチ処理**: 大量のファイル操作時のCore Data更新をバッチ化。

## 4. 技術スタック
- **言語**: Swift 5.9+
- **フレームワーク**: SwiftUI, AppKit, Core Data, AVFoundation, MapKit, QuickLook
- **アーキテクチャ**: MVVM (Model-View-ViewModel)
- **並行処理**: Swift Concurrency (async/await, Task, Actor, MainActor)

## 5. 最近の修正 (Round 99-106)
- **カタログ/フォルダ選択**: ドラッグ操作とクリック選択の競合を解消（`HStack` + `.onTapGesture`）。
- **プログレスバー**: 正確な進捗表示とUIのレスポンス改善（スロットリング）。
- **設定保存**: サムネイルペインの幅を永続化。
- **視覚フィードバック**: 選択項目のハイライト（青背景・白文字）を強化。
